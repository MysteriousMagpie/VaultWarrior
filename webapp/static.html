<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vault Web</title>
<style>
body { font-family: system-ui, sans-serif; margin: 0; display: flex; height: 100vh; }
#sidebar { width: 300px; border-right: 1px solid #ddd; padding: 0.75rem; overflow-y:auto; }
#main { flex: 1; display: flex; flex-direction: column; }
#chat { flex: 1; overflow-y:auto; padding: 0.75rem; }
.msg { margin:0 0 0.75rem; line-height:1.4; }
.role { font-weight:600; margin-right:4px; }
.msg pre { background:#0f172a; color:#e2e8f0; padding:6px 8px; border-radius:4px; overflow:auto; }
.msg code { background:#1e293b; padding:2px 4px; border-radius:4px; }
.msg h1,.msg h2,.msg h3 { margin:0.6em 0 0.4em; line-height:1.2; }
.msg ul { margin:0.4em 0 0.4em 1.25em; padding:0; }
.msg blockquote { border-left:4px solid #94a3b8; margin:0.4em 0; padding:0.25em 0 0.25em 0.75em; color:#475569; background:#f1f5f9; }
#input { display:flex; gap:0.5rem; padding:0.5rem; border-top:1px solid #ddd; }
pre { background:#f6f8fa; padding:0.5rem; border-radius:4px; }
.file { font-size: 0.85rem; margin:0 0 2px; }
.thread { cursor:pointer; padding:2px 4px; border-radius:4px; }
.thread:hover { background:#eee; }
#vaultPicker { margin-bottom:0.5rem; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; }
.modal-inner { background:#fff; width:480px; max-height:70vh; overflow:auto; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.25); padding:0.75rem; }
.entry { cursor:pointer; padding:2px 4px; border-radius:4px; }
.entry:hover { background:#eef; }
.crumb { cursor:pointer; color:#0366d6; }
.crumb + .crumb:before { content:'/'; margin:0 4px; color:#666; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Setup</h3>
  <input id="vaultPath" placeholder="/path/to/vault" style="width:100%;" />
  <button id="browseVault">Browseâ€¦</button>
  <button id="setVault">Use Path</button>
  <button id="reindex">Reindex</button>
  <div id="status" style="margin-top:0.5rem; font-size:0.8rem; color:#555"></div>
  <h3>Files</h3>
  <div id="files"></div>
  <button id="openFile">Open Selected</button>
  <div style="margin-top:0.5rem;">
    <textarea id="fileContent" style="width:100%;height:120px;display:none;"></textarea>
    <button id="saveFile" style="display:none;">Save</button>
  </div>
  <h3>Threads</h3>
  <div id="threads"></div>
  <input id="newThread" placeholder="new-thread" style="width:100%;" />
  <button id="addThread">Add Thread</button>
</div>
<div id="main">
  <div id="chat"></div>
  <div id="input">
    <input id="question" placeholder="Ask or chat..." style="flex:1;" />
    <button id="askBtn">Ask</button>
    <button id="chatBtn">Chat</button>
  </div>
</div>
<div class="modal" id="vaultModal">
  <div class="modal-inner">
    <h3>Select Vault</h3>
    <div id="crumbs" style="font-size:0.8rem; margin-bottom:4px;"></div>
    <div id="dirList" style="border:1px solid #ddd; padding:4px; min-height:200px;"></div>
    <div style="margin-top:6px; text-align:right;">
      <button id="chooseDir" disabled>Choose This Folder</button>
      <button id="closeModal">Cancel</button>
    </div>
  </div>
</div>
<script>
let currentThread = null;
let selectedFile = null;
let browsePath = '';
async function api(path, opts={}) {
  const r = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
  if(!r.ok){ throw new Error(await r.text()) }
  return r.json();
}
function renderMarkdown(md){
  // very small markdown subset converter (no external deps)
  md = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  md = md.replace(/^```(\w+)?\n([\s\S]*?)```/gm, (m,lang,code)=>`<pre><code class="lang-${lang||''}">${code.replace(/`/g,'&#96;')}</code></pre>`);
  md = md.replace(/^### (.*)$/gm,'<h3>$1</h3>').replace(/^## (.*)$/gm,'<h2>$1</h2>').replace(/^# (.*)$/gm,'<h1>$1</h1>');
  md = md.replace(/^> (.*)$/gm,'<blockquote>$1</blockquote>');
  md = md.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');
  md = md.replace(/`([^`]+)`/g,'<code>$1</code>');
  md = md.replace(/^- (.*)$/gm,'<ul><li>$1</li></ul>');
  // collapse consecutive <ul>
  md = md.replace(/<\/ul>\n<ul>/g,'');
  md = md.split(/\n{2,}/).map(p=>/^<h[1-3]|^<pre|^<blockquote|^<ul/.test(p)?p:`<p>${p.replace(/\n/g,'<br/>')}</p>`).join('\n');
  return md;
}
function appendChat(role, text){
  const el=document.getElementById('chat');
  const div=document.createElement('div');
  div.className='msg';
  const content = renderMarkdown(text);
  div.innerHTML = `<span class='role'>${role}:</span> ${content}`;
  el.appendChild(div); el.scrollTop=el.scrollHeight;
}
async function refreshTree(){
  try {
    const data = await api('/api/tree');
    const files = document.getElementById('files');
    files.innerHTML = '';
    data.files.slice(0,500).forEach(f=>{
      const d=document.createElement('div'); d.className='file'; d.textContent=f.file; d.onclick=()=>{selectedFile=f.file; document.querySelectorAll('.file').forEach(n=>n.style.background=''); d.style.background='#e0f3ff';}; files.appendChild(d);
    });
  } catch(e){ console.warn(e); }
  try {
    const data = await api('/api/threads');
    const tdiv = document.getElementById('threads'); tdiv.innerHTML='';
    data.threads.forEach(t=>{
      const d=document.createElement('div'); d.className='thread'; d.textContent=t; d.onclick=()=>{currentThread=t; appendChat('system', 'Selected thread '+t);}; tdiv.appendChild(d);
    });
  } catch(e){ console.warn(e); }
}

document.getElementById('setVault').onclick = async () => {
  const path = document.getElementById('vaultPath').value.trim();
  if(!path) return;
  try {
    const res = await api('/api/vault', {method:'POST', body: JSON.stringify({path})});
    document.getElementById('status').textContent='Vault: '+res.vault;
    await refreshTree();
  } catch(e){ alert(e); }
};

async function loadDir(rel=''){
  const data = await api('/api/list?rel='+encodeURIComponent(rel));
  browsePath = data.path;
  const dirList = document.getElementById('dirList');
  dirList.innerHTML='';
  data.entries.forEach(e=>{
    if(e.type==='file') return; // only dirs selectable
    const d=document.createElement('div'); d.className='entry'; d.textContent=e.name+'/';
    d.onclick=()=>{ loadDir((browsePath?browsePath+'/':'')+e.name); };
    dirList.appendChild(d);
  });
  const crumbsEl=document.getElementById('crumbs');
  crumbsEl.innerHTML='';
  const parts=browsePath?browsePath.split('/'):[];
  let accum='';
  const rootCrumb=document.createElement('span'); rootCrumb.textContent='.'; rootCrumb.className='crumb'; rootCrumb.onclick=()=>loadDir(''); crumbsEl.appendChild(rootCrumb);
  parts.forEach((p,i)=>{ accum += (i?'/':'')+p; const c=document.createElement('span'); c.textContent=p; c.className='crumb'; c.onclick=()=>loadDir(accum); crumbsEl.appendChild(c); });
  document.getElementById('chooseDir').disabled=false;
}

document.getElementById('browseVault').onclick = async () => {
  document.getElementById('vaultModal').style.display='flex';
  try { await loadDir(''); } catch(e){ alert(e); }
};
document.getElementById('closeModal').onclick = () => {
  document.getElementById('vaultModal').style.display='none';
};
document.getElementById('chooseDir').onclick = () => {
  const vp=document.getElementById('vaultPath');
  vp.value = browsePath ? (browsePath.startsWith('.')?browsePath:('./'+browsePath)) : '.';
  document.getElementById('vaultModal').style.display='none';
};

document.getElementById('reindex').onclick = async () => {
  try { const m = await api('/api/index', {method:'POST'}); appendChat('system', 'Indexed '+m.total_chunks+' chunks'); }
  catch(e){ alert(e); }
};

document.getElementById('addThread').onclick = async () => {
  const slug = document.getElementById('newThread').value.trim();
  if(!slug) return;
  try { await api('/api/thread', {method:'POST', body:JSON.stringify({slug})}); currentThread=slug; appendChat('system', 'Thread created '+slug); refreshTree(); }
  catch(e){ alert(e); }
};

document.getElementById('askBtn').onclick = async () => {
  const q = document.getElementById('question').value.trim(); if(!q) return;
  appendChat('you', q);
  try { const res = await api('/api/ask', {method:'POST', body:JSON.stringify({question:q})}); appendChat('assistant', '[results]\n'+res.results.map(r=>r.file+' '+(r.heading||'')).join('\n')); }
  catch(e){ appendChat('error', e); }
};

document.getElementById('chatBtn').onclick = async () => {
  const q = document.getElementById('question').value.trim(); if(!q) return;
  if(!currentThread){ alert('Select or create a thread first'); return; }
  appendChat('you', q);
  try { const res = await api('/api/chat', {method:'POST', body:JSON.stringify({thread:currentThread,message:q,write:true})}); appendChat('assistant', res.answer); }
  catch(e){ appendChat('error', e); }
};

document.getElementById('openFile').onclick = async () => {
  if(!selectedFile){ alert('Select a file first'); return; }
  try { const res = await api('/api/file?path='+encodeURIComponent(selectedFile));
    const ta=document.getElementById('fileContent');
    ta.style.display='block';
    document.getElementById('saveFile').style.display='inline-block';
    ta.value=res.content;
  } catch(e){ alert(e); }
};

document.getElementById('saveFile').onclick = async () => {
  if(!selectedFile) return;
  try { await api('/api/file', {method:'PUT', body:JSON.stringify({path:selectedFile, content:document.getElementById('fileContent').value})}); appendChat('system','Saved '+selectedFile); }
  catch(e){ alert(e); }
};
</script>
</body>
</html>
