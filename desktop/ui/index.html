<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VaultWarrior Desktop</title>
<style>
body { font-family: system-ui, sans-serif; margin:0; }
header { display:flex; gap:0.5rem; padding:0.5rem; background:#1e293b; color:#fff; align-items:center; }
button { cursor:pointer; }
#log { font-size:12px; background:#0f172a; color:#cbd5e1; padding:4px; height:90px; overflow:auto; }
#appframe { width:100%; height: calc(100vh - 140px); border:0; }
.badge { background:#334155; padding:2px 6px; border-radius:12px; font-size:11px; }
</style>
<script src="tauri-bridge.js"></script>
<script>
let backendPort = 37999;
function log(msg){ const el=document.getElementById('log'); if(!el) return; el.textContent += msg+"\n"; el.scrollTop=el.scrollHeight; }

function tauriReady(cb){
  const check = () => {
    if(window.__TAURI__ && (window.__TAURI__.invoke || window.__TAURI__.tauri?.invoke || window.__TAURI__.core?.invoke)) return cb();
    requestAnimationFrame(check);
  }; check();
}

tauriReady(() => {
  const invoke = window.__TAURI__.invoke || window.__TAURI__.core?.invoke || window.__TAURI__.tauri?.invoke;
  const openDialog = window.__TAURI__.dialog?.open || window.__TAURI__.core?.dialog?.open || window.__TAURI__.tauri?.dialog?.open;
  if(!invoke) log('invoke still missing after ready.');
  if(!openDialog) log('dialog.open missing.');

  async function ensureBackend(){
    try {
      const info = await invoke('start_backend', {});
      backendPort = info.port;
      log('Backend on port '+backendPort);
      document.getElementById('appframe').src = 'http://127.0.0.1:'+backendPort+'/app/static.html';
    } catch(e){ console.error(e); log('Backend error: '+e); }
  }

  async function selectVault(){
    if(typeof openDialog !== 'function'){ log('Dialog API unavailable'); return; }
    try {
      const dir = await openDialog({ directory: true, multiple: false, title: 'Select Vault Folder' });
      if(!dir){ log('No vault selected.'); return; }
      log('Selected vault: '+dir);
      await fetch('http://127.0.0.1:'+backendPort+'/api/vault', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path: dir})});
      log('Vault registered.');
    } catch(e){ console.error(e); log('Vault select error: '+e); }
  }

  async function reindex(){
    try {
      const r = await fetch('http://127.0.0.1:'+backendPort+'/api/index', {method:'POST'});
      if(!r.ok){ log('Reindex failed '+r.status); return; }
      const j = await r.json();
      log('Indexed '+j.total_chunks+' chunks');
    } catch(e){ console.error(e); log('Reindex error '+e); }
  }

  document.getElementById('btnVault').addEventListener('click', selectVault);
  document.getElementById('btnReindex').addEventListener('click', reindex);
  ensureBackend();
});
</script>
</head>
<body>
<header>
  <strong>VaultWarrior Desktop</strong>
  <span class="badge">Tauri</span>
  <button id="btnVault">Select Vault</button>
  <button id="btnReindex">Reindex</button>
</header>
<iframe id="appframe"></iframe>
<pre id="log"></pre>
</body>
</html>
