<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>VaultWarrior Desktop</title>
<style>
body { font-family: system-ui, sans-serif; margin:0; }
header { display:flex; gap:0.5rem; padding:0.5rem; background:#1e293b; color:#fff; align-items:center; }
button { cursor:pointer; }
#log { font-size:12px; background:#0f172a; color:#cbd5e1; padding:4px; height:90px; overflow:auto; }
#appframe { width:100%; height: calc(100vh - 140px); border:0; }
.badge { background:#334155; padding:2px 6px; border-radius:12px; font-size:11px; }
</style>
<!-- Load Tauri JS global (dev server serves this automatically) -->
<script src="tauri.js"></script>
<script>
let backendPort = 37999;
function log(msg){ const el=document.getElementById('log'); if(!el) return; el.textContent += msg+"\n"; el.scrollTop=el.scrollHeight; }

function getApi(){ return window.__TAURI__ || {}; }

async function ensureBackend(){
  const api = getApi();
  const invoke = api.invoke || api.core?.invoke || api.tauri?.invoke;
  if(!invoke){ log('invoke missing (waiting 100ms)'); return setTimeout(ensureBackend, 100); }
  try {
    const info = await invoke('start_backend', {});
    backendPort = info.port;
    log('Backend on port '+backendPort);
    document.getElementById('appframe').src = 'http://127.0.0.1:'+backendPort+'/app/static.html';
  } catch(e){ console.error(e); log('Backend error: '+e); }
}

async function selectVault(){
  const api = getApi();
  const open = api.dialog?.open || api.core?.dialog?.open || api.tauri?.dialog?.open;
  if(typeof open !== 'function'){
    log('Dialog API unavailable (retrying soon)');
    console.warn('Dialog API missing on __TAURI__');
    return setTimeout(selectVault, 300);
  }
  log('Select Vault clicked');
  try {
    const dir = await open({ directory: true, multiple: false, title: 'Select Vault Folder' });
    if(!dir){ log('No vault selected.'); return; }
    log('Selected vault: '+dir);
    await fetch('http://127.0.0.1:'+backendPort+'/api/vault', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path: dir})});
    log('Vault registered.');
  } catch(e){ console.error(e); log('Vault select error: '+e); }
}

async function reindex(){
  log('Reindex requested...');
  try {
    const r = await fetch('http://127.0.0.1:'+backendPort+'/api/index', {method:'POST'});
    if(!r.ok){ log('Reindex failed '+r.status); return; }
    const j = await r.json();
    log('Indexed '+j.total_chunks+' chunks');
  } catch(e){ console.error(e); log('Reindex error '+e); }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnVault').addEventListener('click', selectVault);
  document.getElementById('btnReindex').addEventListener('click', reindex);
  ensureBackend();
});
</script>
</head>
<body>
<header>
  <strong>VaultWarrior Desktop</strong>
  <span class="badge">Tauri</span>
  <button id="btnVault">Select Vault</button>
  <button id="btnReindex">Reindex</button>
</header>
<iframe id="appframe"></iframe>
<pre id="log"></pre>
</body>
</html>
